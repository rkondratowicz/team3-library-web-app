<!-- Success Messages -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const successParam = urlParams.get('success');
    
    let alertDiv;
    let message = '';
    
    if (successParam === 'copy-added') {
        message = '<i class="fas fa-check-circle"></i> <strong>Success!</strong> Book copy has been added successfully.';
    } else if (successParam === 'copies-added') {
        const count = urlParams.get('count') || 'multiple';
        message = `<i class="fas fa-check-circle"></i> <strong>Success!</strong> ${count} book copies have been added successfully.`;
    } else if (successParam === 'partial-success') {
        const added = urlParams.get('added') || '0';
        const failed = urlParams.get('failed') || '0';
        message = `<i class="fas fa-exclamation-triangle"></i> <strong>Partial Success:</strong> ${added} copies added successfully, ${failed} failed.`;
    }
    
    if (message) {
        // Create and show success alert
        alertDiv = document.createElement('div');
        alertDiv.className = successParam === 'partial-success' 
            ? 'alert alert-warning alert-dismissible fade show'
            : 'alert alert-success alert-dismissible fade show';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Insert at the top of the page
        const container = document.querySelector('.container-fluid') || document.body;
        container.insertBefore(alertDiv, container.firstChild);
        
        // Remove the success parameters from URL
        if (window.history.replaceState) {
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
            window.history.replaceState({path: newUrl}, '', newUrl);
        }
    }
});
</script>

<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-book"></i> Book Details
            </h1>
            <div class="btn-group">
                <a href="/books/{{book.id}}/edit" class="btn btn-primary">
                    <i class="fas fa-edit"></i> Edit
                </a>
                <button class="btn btn-danger" onclick="deleteBook('{{book.id}}')">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">{{book.title}}</h3>
                    <div class="d-flex gap-2">
                        <span class="badge {{#if book.available}}bg-success{{else}}bg-danger{{/if}} fs-6">
                            {{#if book.available}}Available{{else}}All Checked Out{{/if}}
                        </span>
                        {{#if book.totalCopies}}
                        <span class="badge bg-info fs-6">
                            {{book.availableCopies}}/{{book.totalCopies}} copies
                        </span>
                        {{else}}
                        <span class="badge bg-secondary fs-6">
                            No copies
                        </span>
                        {{/if}}
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-sm-3">
                        <strong>Author:</strong>
                    </div>
                    <div class="col-sm-9">
                        {{book.author}}
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-sm-3">
                        <strong>ISBN:</strong>
                    </div>
                    <div class="col-sm-9">
                        <code>{{book.isbn}}</code>
                    </div>
                </div>

                {{#if book.publishedYear}}
                <div class="row mb-4">
                    <div class="col-sm-3">
                        <strong>Published Year:</strong>
                    </div>
                    <div class="col-sm-9">
                        {{book.publishedYear}}
                    </div>
                </div>
                {{/if}}

                {{#if book.category}}
                <div class="row mb-4">
                    <div class="col-sm-3">
                        <strong>Category:</strong>
                    </div>
                    <div class="col-sm-9">
                        <span class="badge bg-info">{{book.category}}</span>
                    </div>
                </div>
                {{/if}}

                {{#if book.description}}
                <div class="row mb-4">
                    <div class="col-sm-3">
                        <strong>Description:</strong>
                    </div>
                    <div class="col-sm-9">
                        <p class="mb-0">{{book.description}}</p>
                    </div>
                </div>
                {{/if}}

                <div class="row mb-4">
                    <div class="col-sm-3">
                        <strong>Added:</strong>
                    </div>
                    <div class="col-sm-9">
                        {{formatDate book.createdAt}}
                    </div>
                </div>

                {{#if book.updatedAt}}
                <div class="row mb-4">
                    <div class="col-sm-3">
                        <strong>Last Updated:</strong>
                    </div>
                    <div class="col-sm-9">
                        {{formatDate book.updatedAt}}
                    </div>
                </div>
                {{/if}}
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Availability Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-clipboard-list"></i> Availability
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center mb-3">
                    <div class="col-3">
                        <div class="statistic">
                            <h4 class="text-primary">{{book.totalCopies}}</h4>
                            <small class="text-muted">Total</small>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="statistic">
                            <h4 class="text-success">{{book.availableCopies}}</h4>
                            <small class="text-muted">Available</small>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="statistic">
                            <h4 class="text-warning">{{book.checkedOutCopies}}</h4>
                            <small class="text-muted">Checked Out</small>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="statistic">
                            <h4 class="text-danger">{{book.maintenanceCopies}}</h4>
                            <small class="text-muted">Maintenance</small>
                        </div>
                    </div>
                </div>

                {{#if book.totalCopies}}
                <!-- Individual Copy Status -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="text-muted mb-0">Copy Inventory:</h6>
                        <small class="text-muted">
                            {{book.availableCopies}}/{{book.totalCopies}} available
                        </small>
                    </div>
                    <div class="d-flex flex-wrap gap-1">
                        {{#each book.copies}}
                        <span class="badge {{statusClass status}} fs-6 {{#if borrower}}copy-clickable{{/if}}" 
                              {{#if borrower}}data-bs-toggle="modal" data-bs-target="#borrowerModal" 
                              data-copy-number="{{copy_number}}" 
                              data-borrower-name="{{borrower.name}}" 
                              data-borrower-email="{{borrower.email}}" 
                              data-borrowed-date="{{borrower.borrowed_date}}" 
                              data-due-date="{{borrower.due_date}}"
                              style="cursor: pointer;" 
                              title="Click to see borrower details"{{/if}}>
                            <i class="{{statusIcon status}}"></i>
                            Copy #{{copy_number}} - {{status}} ({{condition}})
                            {{#if borrower}}<i class="fas fa-info-circle ms-1"></i>{{/if}}
                        </span>
                        {{/each}}
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i>
                            Copy IDs are unique across the entire library collection
                        </small>
                    </div>
                </div>
                {{/if}}

                {{#if book.available}}
                <div class="d-grid">
                    <a href="/books/{{book.id}}/checkout" class="btn btn-success">
                        <i class="fas fa-check"></i> Available for Checkout
                    </a>
                </div>
                {{else}}
                <div class="d-grid">
                    <button class="btn btn-warning" disabled>
                        <i class="fas fa-clock"></i> All Copies Checked Out
                    </button>
                </div>
                {{/if}}
            </div>
        </div>

        <!-- Actions Card -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-tools"></i> Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="/books/{{book.id}}/add-copy" class="btn btn-success">
                        <i class="fas fa-plus"></i> Add Book Copy
                    </a>
                    <a href="/books/{{book.id}}/edit" class="btn btn-primary">
                        <i class="fas fa-edit"></i> Edit Book
                    </a>
                    <button class="btn btn-outline-secondary" onclick="window.print()">
                        <i class="fas fa-print"></i> Print Details
                    </button>
                    <button class="btn btn-outline-info" onclick="shareBook('{{book.id}}')">
                        <i class="fas fa-share"></i> Share Book
                    </button>
                    <hr>
                    <button class="btn btn-danger" onclick="deleteBook('{{book.id}}')">
                        <i class="fas fa-trash"></i> Delete Book
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Navigation -->
<div class="row mt-4">
    <div class="col-12">
        <div class="d-flex justify-content-between">
            <a href="/books" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Books
            </a>
            <div class="btn-group">
                {{#if previousBook}}
                <a href="/books/{{previousBook.id}}" class="btn btn-outline-primary">
                    <i class="fas fa-chevron-left"></i> Previous
                </a>
                {{/if}}
                {{#if nextBook}}
                <a href="/books/{{nextBook.id}}" class="btn btn-outline-primary">
                    Next <i class="fas fa-chevron-right"></i>
                </a>
                {{/if}}
            </div>
        </div>
    </div>
</div>

<!-- Borrower Information Modal -->
<div class="modal fade" id="borrowerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user"></i> Borrower Information - Copy #<span id="modal-copy-number"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>Borrower:</strong>
                    </div>
                    <div class="col-sm-8">
                        <span id="modal-borrower-name"></span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>Email:</strong>
                    </div>
                    <div class="col-sm-8">
                        <a href="#" id="modal-borrower-email"></a>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>Borrowed Date:</strong>
                    </div>
                    <div class="col-sm-8">
                        <span id="modal-borrowed-date"></span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>Due Date:</strong>
                    </div>
                    <div class="col-sm-8">
                        <span id="modal-due-date"></span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" class="btn btn-primary" id="modal-member-link">
                    <i class="fas fa-user"></i> View Member Profile
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete "<strong>{{book.title}}</strong>"?</p>
                <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle borrower modal population
    const borrowerModal = document.getElementById('borrowerModal');
    if (borrowerModal) {
        borrowerModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            
            // Extract data attributes
            const copyNumber = button.getAttribute('data-copy-number');
            const borrowerName = button.getAttribute('data-borrower-name');
            const borrowerEmail = button.getAttribute('data-borrower-email');
            const borrowedDate = button.getAttribute('data-borrowed-date');
            const dueDate = button.getAttribute('data-due-date');
            
            // Format dates for better display
            const formatDate = (dateString) => {
                if (!dateString) return '';
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            };
            
            // Populate modal fields
            document.getElementById('modal-copy-number').textContent = copyNumber;
            document.getElementById('modal-borrower-name').textContent = borrowerName;
            document.getElementById('modal-borrower-email').textContent = borrowerEmail;
            document.getElementById('modal-borrower-email').href = `mailto:${borrowerEmail}`;
            document.getElementById('modal-borrowed-date').textContent = formatDate(borrowedDate);
            document.getElementById('modal-due-date').textContent = formatDate(dueDate);
            
            // Set member profile link (assuming members have URL structure /members/search?email=...)
            const memberLink = document.getElementById('modal-member-link');
            memberLink.href = `/members/search?email=${encodeURIComponent(borrowerEmail)}`;
        });
    }
});
</script>