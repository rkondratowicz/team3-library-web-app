{{#> layouts/main title=title}}

<div class="container-fluid py-4">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h1 class="h2 mb-0">Select Member for Checkout</h1>
          <p class="text-muted mb-0">
            Choose a member to check out: <strong>{{book.title}}</strong>
          </p>
        </div>
        <a href="/books/{{book.id}}" class="btn btn-outline-secondary">
          <i class="fas fa-arrow-left"></i> Back to Book Details
        </a>
      </div>

      <!-- Book Info Card -->
      <div class="card mb-4 bg-light">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h5 class="card-title mb-1">{{book.title}}</h5>
              <p class="card-text text-muted mb-0">
                <i class="fas fa-user"></i> {{book.author}} 
                {{#if book.isbn}}
                | <i class="fas fa-barcode"></i> {{book.isbn}}
                {{/if}}
              </p>
            </div>
            <div class="col-md-4 text-md-end">
              <span class="badge bg-success fs-6">
                {{book.availableCopies}} available copies
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Search Form -->
      <form method="GET" action="/books/{{book.id}}/checkout" class="mb-3">
        <div class="input-group">
          <input 
            type="text" 
            class="form-control" 
            name="search" 
            value="{{searchTerm}}" 
            placeholder="Search members by name, email, or phone..."
            aria-label="Search members"
          >
          <button class="btn btn-outline-secondary" type="submit">
            <i class="fas fa-search"></i> Search
          </button>
          {{#if searchTerm}}
          <a href="/books/{{book.id}}/checkout" class="btn btn-outline-danger">
            <i class="fas fa-times"></i> Clear
          </a>
          {{/if}}
        </div>
      </form>

      <!-- Search Info -->
      {{#if isSearchResult}}
      <div class="alert alert-info">
        <i class="fas fa-info-circle"></i>
        Found <strong>{{resultCount}}</strong> member(s) matching "<strong>{{searchTerm}}</strong>"
      </div>
      {{else}}
      <p class="text-muted">
        Total: <strong>{{resultCount}}</strong> active members
      </p>
      {{/if}}
    </div>
  </div>

  <!-- Members List -->
  <div class="row">
    {{#if members}}
      {{#if (eq members.length 0)}}
        <div class="col-12">
          <div class="alert alert-warning text-center">
            <i class="fas fa-exclamation-triangle"></i>
            {{#if isSearchResult}}
              No members found matching your search criteria.
            {{else}}
              No active members found in the library.
            {{/if}}

          </div>
        </div>
      {{else}}

        {{#each members}}
        <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12 mb-4">
          <div class="card h-100 shadow-sm member-card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <h5 class="card-title mb-0">{{memberName}}</h5>
                <span class="badge bg-{{#if (eq status 'active')}}success{{else if (eq status 'suspended')}}warning{{else}}secondary{{/if}}">
                  {{status}}
                </span>
              </div>
              
              <div class="mb-2">
                <small class="text-muted">
                  <i class="fas fa-envelope"></i> {{email}}
                </small>
              </div>
              
              {{#if phone}}
              <div class="mb-2">
                <small class="text-muted">
                  <i class="fas fa-phone"></i> {{phone}}
                </small>
              </div>
              {{/if}}
              
              {{#if memAddress}}
              <div class="mb-3">
                <small class="text-muted">
                  <i class="fas fa-map-marker-alt"></i> {{truncate memAddress 40}}
                </small>
              </div>
              {{/if}}

              <!-- Only show checkout button for active members -->
              {{#if (eq status 'active')}}
              <div class="d-grid">
                <button class="btn btn-primary checkout-member-btn" 
                        data-member-id="{{id}}" 
                        data-member-name="{{memberName}}"
                        data-book-id="{{../book.id}}"
                        data-book-title="{{../book.title}}">
                  <i class="fas fa-check"></i> Select for Checkout
                </button>
              </div>
              {{else}}
              <div class="d-grid">
                <button class="btn btn-secondary" disabled>
                  <i class="fas fa-ban"></i> Member {{status}}
                </button>
              </div>
              {{/if}}
            </div>
          </div>
        </div>
        {{/each}}
      {{/if}}
    {{else}}
      <div class="col-12">
        <div class="alert alert-danger text-center">
          <i class="fas fa-exclamation-circle"></i>
          Error loading members. Please try again.

        </div>
      </div>
    {{/if}}
  </div>
</div>

<!-- Checkout Confirmation Modal -->
<div class="modal fade" id="checkoutModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Checkout</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to check out this book?</p>
        <div class="card bg-light">
          <div class="card-body">
            <h6 class="card-title mb-1" id="modal-book-title"></h6>
            <p class="card-text text-muted mb-0">
              to: <strong id="modal-member-name"></strong>
            </p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" id="confirm-checkout">
          <i class="fas fa-check"></i> Confirm Checkout
        </button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const checkoutButtons = document.querySelectorAll('.checkout-member-btn');
  const modal = new bootstrap.Modal(document.getElementById('checkoutModal'));
  const confirmButton = document.getElementById('confirm-checkout');
  const modalBookTitle = document.getElementById('modal-book-title');
  const modalMemberName = document.getElementById('modal-member-name');
  
  let selectedMemberId = null;
  let selectedBookId = null;

  checkoutButtons.forEach(button => {
    button.addEventListener('click', function() {
      selectedMemberId = this.dataset.memberId;
      selectedBookId = this.dataset.bookId;
      
      modalBookTitle.textContent = this.dataset.bookTitle;
      modalMemberName.textContent = this.dataset.memberName;
      
      modal.show();
    });
  });

  confirmButton.addEventListener('click', async function() {
    if (!selectedMemberId || !selectedBookId) return;
    
    try {
      // Show loading state
      confirmButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
      confirmButton.disabled = true;
      
      const response = await fetch(`/api/books/${selectedBookId}/checkout`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          memberId: selectedMemberId
        })
      });
      
      if (response.ok) {
        // Success - redirect to book details
        window.location.href = `/books/${selectedBookId}`;
      } else {
        // Handle error
        const error = await response.json();
        alert('Error: ' + (error.message || 'Failed to checkout book'));
        
        // Reset button state
        confirmButton.innerHTML = '<i class="fas fa-check"></i> Confirm Checkout';
        confirmButton.disabled = false;
      }
    } catch (error) {
      console.error('Checkout error:', error);
      alert('Error: Failed to checkout book');
      
      // Reset button state
      confirmButton.innerHTML = '<i class="fas fa-check"></i> Confirm Checkout';
      confirmButton.disabled = false;
    }
  });
});
</script>

{{/layouts/main}}